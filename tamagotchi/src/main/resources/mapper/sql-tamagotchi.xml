<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tamagotchi.mapper.TamagotchiMapper">
	<!-- 다마고치 전체 리스트 출력 -->
    <select id="selectTamagotchiList" resultType="tamagotchi.dto.TamagotchiDto">
        select tamagotchi_id, name, level_number, hunger, fatigue, happiness
          from tamagotchis_M
         where deleted_yn = 'N'
         order by tamagotchi_id
    </select>
   
   <!-- 다마고치 등록 -->
    <insert id="insertTamagotchi" useGeneratedKeys="true" keyProperty="tamagotchiId">
        insert into tamagotchis_M(name, level_number, hunger, fatigue, happiness, create_dt, update_dt)
   		values (#{name}, #{levelNumber}, #{hunger}, #{fatigue}, #{happiness}, now(), now())
    </insert>
    
    
    <insert id="insertTamagotchiFileList">
        insert into tamagotchis_F 
            (tamagotchi_id, image_url, original_file_name, stored_file_path, file_size, create_dt, update_dt)
        values 
        <foreach collection="list" item="item" separator=",">
            (#{item.tamagotchiId}, #{item.imageUrl}, #{item.originalFileName}, #{item.storedFilePath}, #{item.fileSize}, now(), now())
        </foreach>
    </insert>
    
    <select id="selectTamagotchiDetail" parameterType="int" resultType="tamagotchi.dto.TamagotchiDto">
	    SELECT 
		    m.tamagotchi_id,
		    m.level_number,
		    m.name,
		    m.hunger,
		    m.fatigue,
		    m.happiness,
		    date_format(m.create_dt, '%Y.%m.%d %H:%i:%s') as create_dt
		FROM 
		    tamagotchis_M m
		WHERE 
		    m.deleted_yn = 'N' 
		    AND m.tamagotchi_id = #{tamagotchiId};
	</select>

	<update id="updateState">
		update tamagotchis_M
           set hunger = #{hunger}
             , fatigue = #{fatigue}
             , happiness = #{happiness}
             , update_dt = now()
         where tamagotchi_id = #{tamagotchiId} 
	</update>
    
    <update id="updateDay">
        update tamagotchis_M
           set hunger = hunger + 10
             , fatigue = fatigue + 10
             , happiness = happiness - 10
             , update_dt = now()
         where deleted_yn = 'N' 
    </update>
    
    <delete id="deleteTamagotchi">
        update tamagotchis_M
           set deleted_yn = 'Y' 
             , update_dt = now()
         where tamagotchi_id = #{tamagotchiId}  
    </delete>
    
    <select id="selectTamagotchiFileList" parameterType="int" resultType="tamagotchi.dto.TamagotchiFileDto">
        select image_id, tamagotchi_id, original_file_name, format(round(file_size/1024), 0) as file_size, stored_file_path
          from tamagotchis_F
         where tamagotchi_id = #{tamagotchiId}
    </select>
    
    <select id="selectTamagotchiFileInfo" parameterType="map" resultType="tamagotchi.dto.TamagotchiFileDto">
        select image_id, original_file_name, stored_file_path, file_size
          from tamagotchis_F
         where image_id = #{imageId} and tamagotchi_id = #{tamagotchiId}
    </select>
</mapper>
