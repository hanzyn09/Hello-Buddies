<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My-Tama-Friend</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
       <style>
        /* 기본 색상 설정 */
        :root {
            --primary-color: #7ed957; /* 보라색 계열 */
            --secondary-color: #5e3a8c; /* 보라색 계열 */
            --tertiary-color: #f8f9fa; /* 배경색 */
            --highlight-color: #f1c40f; /* 노란색 계열 */
            --button-hover-color: #66d047; /* 보라색 계열 */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }

        .container {
            width: 80%;
            margin: 50px auto;
            padding: 40px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #6a4c9c; /* 보라색 계열 */
            font-size: 40px;
            margin-bottom: 30px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: center;
            font-size: 18px;
        }

        th {
            background-color: #f3e4f7;
            font-weight: bold;
            color: var(--secondary-color);
            cursor: pointer;
            border-bottom: 2px solid #ddd;
        }

        th:hover {
            background-color: #e0c7e4;
        }

        td {
            background-color: #faf1f9;
            border-bottom: 1px solid #ddd;
        }

        .status {
            font-weight: bold;
            border-radius: 5px;
            padding: 5px 10px;
            color: white;
            position: relative;
            cursor: pointer;
        }

        .status.active {
            color : green;
        }

        .status.inactive {   
            color : red;
        }

        /* 툴팁 스타일 */
        .status-tooltip {
            visibility: hidden;
            position: absolute;
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            font-size: 14px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 1000;
        }

        .status:hover .status-tooltip {
            visibility: visible;
        }

        .search-container {
            margin-bottom: 20px;
            text-align: center;
        }

        .search-input {
            width: 60%;
            padding: 12px;
            font-size: 16px;
            border-radius: 30px;
            border: 2px solid #ddd;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 5px rgba(94, 58, 140, 0.3);
        }

        /* 공통 버튼 스타일 */
        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            background-color: var(--secondary-color);
            color: white;
            font-size: 16px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: none; /* 버튼 테두리 없애기 */
        }

        .btn:hover {
            background-color: var(--button-hover-color);
        }

        .btn-primary {
            background-color: #9b59b6; /* 보라색 */
		    color: white;
        }

        .btn-primary:hover {
            background-color: #8e44ad; /* 더 진한 보라색 */
            color: black;
        }

        .btn-secondary {
            background-color: #FFE942; /* 밝은 노란색 */
		    color: #6a4c9c;
        }

        .btn-secondary:hover {
            background-color: #D8C217; /* 더 밝은 노란색 (호버 시) */
            color: white;
        }

        /* 뒤로가기 버튼 스타일 */
        .btn-back {
            display: inline-block;
            border-radius: 50px;
            background-color: #FFE942; /* 밝은 노란색 */
            color: #6a4c9c;
            font-size: 18px;
            text-align: center;
            text-decoration: none;
            padding: 10px 20px;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-back:hover {
            background-color: #D8C217; /* 더 밝은 노란색 (호버 시) */
            color: white;
            text-decoration: none;  /* hover 시에도 밑줄 없애기 */
        }

        /* 버튼 감싸는 div 스타일 */
        .btn-wrapper {
            display: flex;
            justify-content: center; /* 버튼 중앙 정렬 */
            margin-top: 10px; /* 버튼과 컨테이너 사이의 간격을 조정 */
        }

        .responsibility-text {
            text-align: center;
            font-size: 16px;
            color: var(--secondary-color);
            margin: 10px 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: 1px;
        }

        .tama-count {
            font-weight: bold;
            font-size: 23px;
            color: var(--primary-color);
        }

        /* 하루 건너 뛰기 버튼 스타일 */
        .btn-day {
            background-color: #6a4c9c; /* 더 진한 보라색 */
		    color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 16px;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* 마우스를 올렸을 때 더 진한 보라색 */
        .btn-day:hover {
            background-color: #5c3a73; /* 더 진하고 어두운 보라색 */
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 onclick="refreshPage()">My-Tama-Friend</h1> <!-- 타이틀 클릭 시 새로고침 함수 호출 -->
			
        <div class="search-container" style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
		    <input type="text" id="searchInput" class="search-input" placeholder="이름 검색..." onkeyup="searchTamagotchi()">
		</div>

        <table id="tamagotchiTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0, 'number')">탄생 순서</th>
                    <th onclick="sortTable(1, 'string')">이름</th>
                    <th title="레벨업을 시켜보세요!" onclick="sortTable(2, 'number')">레벨</th>
                    <th title="배고픔" onclick="sortTable(3, 'number')"><i class="fas fa-utensils icon"></i></th>
                    <th title="피로도" onclick="sortTable(4, 'number')"><i class="fas fa-bed icon"></i></th>
                    <th title="행복도" onclick="sortTable(5, 'number')"><i class="fas fa-sun icon"></i></th>
                    <th title="(100 - 배고픔) * 0.2 + (100 - 피로도) * 0.3 + 행복도 * 0.5) / 3, 평균값:16.6" onclick="sortTable(6, 'string')">종합 지수</th>
                    <th title="상세보기를 통해 타마를 돌봐주세요!">상세보기</th>
                </tr>
            </thead>
           <tbody id="tamagotchiTableBody">
			    <!-- 타마고치 목록을 순회하며 출력 -->
			    <tr th:each="tamagotchi, iterStat : ${tamagotchis}">
			        <td th:text="${tamagotchi.tamagotchiId}"></td>
			        <td th:text="${tamagotchi.name}"></td>
			        <td th:text="'Lv. ' + ${tamagotchi.levelNumber}"></td>
			        
			        <td title="배고픔은 0%가 최고의 상태입니다."
				        th:text="${tamagotchi.hunger} + '%'" 
						th:attr="style='color: ' + (${tamagotchi.hunger} >= 80 ? 'red' : 'black')">
					</td>
			        <td title="피로도는 0%가 최고의 상태입니다."
				        th:text="${tamagotchi.fatigue} + '%'" 
						th:attr="style='color: ' + (${tamagotchi.fatigue} >= 80 ? 'red' : 'black')">
					</td>
			        <td title="행복도는 100%가 최고의 상태입니다." 
					    th:text="${tamagotchi.happiness} + '%'" 
					    th:attr="style='color: ' + (${tamagotchi.happiness} <= 30 ? 'red' : 'black')">
					</td>
					
			        <td class="status" 
					    th:classappend="${((100 - tamagotchi.hunger) * 0.2 + (100 - tamagotchi.fatigue) * 0.3 + tamagotchi.happiness * 0.5) / 3 
					                        >= 16.6 ? 'active' : 'inactive'}">
					    <!-- 상태에 따라 다른 아이콘을 표시 -->
					    <span th:class="${((100 - tamagotchi.hunger) * 0.2 + (100 - tamagotchi.fatigue) * 0.3 + tamagotchi.happiness * 0.5) / 3 >= 16.6 ? 'fas fa-smile-beam fa-2x' : 'fas fa-sad-tear fa-2x'}"></span>
					    <span class="status-tooltip" th:text="${((100 - tamagotchi.hunger) * 0.2 + (100 - tamagotchi.fatigue) * 0.3 + tamagotchi.happiness * 0.5) / 3} + '점'"></span>
					</td>	
			        <td>
			            <a href="/tamagotchi/openTamagotchiDetail.do?tamagotchiId=" 
			                th:attrappend="href=${tamagotchi.tamagotchiId}" class="btn btn-secondary">보살피기</a>
			        </td>
			    </tr>
			    <!-- 데이터가 없을 경우 표시할 안내 문구 -->
			    <tr id="noDataRow" style="display: none;">
			        <td colspan="7" style="text-align: center; padding: 20px; font-size: 18px; color: #777;">
			            조회된 다마고치가 없습니다.
			        </td>
			    </tr>
			</tbody>
        </table>

		<div style="display: flex; align-items: center; justify-content: space-between;">
			<!-- 새로 입양하기 버튼 -->
		    <a href="/tamagotchi/createTamagotchi.do" class="btn btn-primary">새로 입양하기</a>
				
				<!-- 타마와 함께하는 시간 표시 텍스트 -->
			    <div class="responsibility-text" style="margin-left: 0;">
			        나는 <span id="activeTamaCount" class="tama-count">0</span> 마리의 타마와 소중한 시간을 함께하고 있어요.
			    </div>
		    
		        <!-- 하루 건너뛰기 버튼 -->
		        <form id="frm" method="post">
		            <button class="btn btn-day" id="btnDay" name="Day" value="Day">하루 건너뛰기</button>
		        </form>
		</div>	
    </div>
    
	 <!-- 버튼을 감싸는 wrapper 추가 -->
    <div class="btn-wrapper">
        <a href="/index.html" class="btn-back">로비로 돌아가기</a>
    </div>  
	  
    <script>
	 	// 타이틀 클릭 시 현재 페이지 새로 고침
	    function refreshPage() {
	        location.reload(); // 페이지 새로 고침
	    }
	 
	    // 페이지 로드 시 데이터가 없는지 확인하고, 없으면 "조회된 다마고치가 없습니다." 안내 문구 표시
	    document.addEventListener("DOMContentLoaded", function() {
	        updateActiveTamaCount(); // 페이지 로드 시 타마고치 수 업데이트
	    });
	 
	    // 하루 건너뛰기 버튼 클릭 시
	    $("#btnDay").on("click", function(event) {
	        event.preventDefault(); // 기본 동작 방지
	
	        // 타마고치가 있는지 확인
	        var tamagotchiRows = document.getElementById("tamagotchiTableBody").getElementsByTagName("tr");
	        var hasData = false;
	        for (var i = 0; i < tamagotchiRows.length; i++) {
	            // 'noDataRow' 행을 제외하고 데이터가 있는지 확인
	            if (tamagotchiRows[i].style.display !== 'none' && tamagotchiRows[i].id !== 'noDataRow') {
	                hasData = true;
	                break;
	            }
	        }
	
	        // 데이터가 없으면 경고 메시지 표시하고 동작 안 함
	        if (!hasData) {
	            alert("현재 키우는 다마고치가 없습니다. 다마고치를 추가해주세요.");
	        } else {
	            alert("하루 건너뛰기 버튼을 클릭했습니다. 다마고치 상태가 변화합니다.");
	            let frm = $("#frm")[0];
	            frm.action = "updateDay.do"; // action을 'updateDay.do'로 설정
	            frm.submit(); // 폼 제출
	        }
	    });
	
	    // 각 열의 정렬 상태를 관리하는 객체
	    var sortDirections = {
	        0: 'asc',
	        1: 'asc',
	        2: 'asc',
	        3: 'asc',
	        4: 'asc'
	    };
	
	    function sortTable(columnIndex) {
	        var table = document.getElementById("tamagotchiTable");
	        var rows = table.getElementsByTagName("tr");
	        var switching = true;
	        var shouldSwitch;
	        var dir = sortDirections[columnIndex]; // 해당 열의 현재 정렬 방향
	
	        // 계속해서 테이블을 반복하며 정렬을 시도합니다.
	        while (switching) {
	            switching = false;
	            var rowsArray = Array.from(rows).slice(1); // 헤더를 제외한 행들을 배열로 변환
	
	            // 모든 행을 하나씩 비교하여 정렬
	            for (var i = 0; i < rowsArray.length - 1; i++) {
	                var x = rowsArray[i].getElementsByTagName("td")[columnIndex];
	                var y = rowsArray[i + 1].getElementsByTagName("td")[columnIndex];
	
	                shouldSwitch = false;
	
	                var xContent = x ? x.textContent.trim() : '';
	                var yContent = y ? y.textContent.trim() : '';
	
	                if (!isNaN(xContent) && !isNaN(yContent)) {
	                    if (dir === "asc") {
	                        if (parseInt(xContent) > parseInt(yContent)) {
	                            shouldSwitch = true;
	                            break;
	                        }
	                    } else if (dir === "desc") {
	                        if (parseInt(xContent) < parseInt(yContent)) {
	                            shouldSwitch = true;
	                            break;
	                        }
	                    }
	                } else {
	                    if (dir === "asc") {
	                        if (xContent.toLowerCase() > yContent.toLowerCase()) {
	                            shouldSwitch = true;
	                            break;
	                        }
	                    } else if (dir === "desc") {
	                        if (xContent.toLowerCase() < yContent.toLowerCase()) {
	                            shouldSwitch = true;
	                            break;
	                        }
	                    }
	                }
	            }
	
	            if (shouldSwitch) {
	                rowsArray[i].parentNode.insertBefore(rowsArray[i + 1], rowsArray[i]);
	                switching = true;
	            } else {
	                // 방향이 변경될 때마다 정렬 방향을 반대로 토글
	                if (dir === "asc") {
	                    sortDirections[columnIndex] = "desc";
	                } else {
	                    sortDirections[columnIndex] = "asc";
	                }
	                switching = false;
	            }
	        }
	    }
	
	    // 데이터가 없는지 확인하여 "조회된 다마고치가 없습니다." 안내 문구 표시
	    document.addEventListener("DOMContentLoaded", function() {
	        var tamagotchiRows = document.getElementById("tamagotchiTableBody").getElementsByTagName("tr");
	        var noDataRow = document.getElementById('noDataRow');
	
	        // 데이터가 없다면 안내 문구를 보이게
	        var hasData = false;
	        for (var i = 0; i < tamagotchiRows.length; i++) {
	            // 데이터 행이 하나라도 있으면 hasData를 true로 설정
	            if (tamagotchiRows[i].id !== 'noDataRow' && tamagotchiRows[i].style.display !== 'none') {
	                hasData = true;
	                break;
	            }
	        }
	
	        if (hasData) {
	            noDataRow.style.display = "none";
	        } else {
	            noDataRow.style.display = "";
	        }
	    });
	
	    // 이름 검색 기능
	    function searchTamagotchi() {
	        var input, filter, table, tr, td, i, txtValue;
	        input = document.getElementById('searchInput');
	        filter = input.value.toLowerCase();
	        table = document.getElementById('tamagotchiTable');
	        tr = table.getElementsByTagName('tr');
	        var noDataRow = document.getElementById('noDataRow'); // 안내 문구
	
	        var found = false; // 검색된 항목이 있는지 확인하는 변수
	
	        for (i = 1; i < tr.length; i++) { // 첫 번째 tr은 헤더이므로 건너뜁니다.
	            td = tr[i].getElementsByTagName('td')[1]; // 이름 열
	            if (td) {
	                txtValue = td.textContent || td.innerText;
	                if (txtValue.toLowerCase().indexOf(filter) > -1) {
	                    tr[i].style.display = "";
	                    found = true; // 검색 결과가 있으면 true로 설정
	                } else {
	                    tr[i].style.display = "none";
	                }
	            }
	        }
	
	        // 검색 결과가 없으면 안내 문구를 보이게 함
	        if (!found) {
	            noDataRow.style.display = "";
	        } else {
	            noDataRow.style.display = "none";
	        }
	
	        // 삭제되지 않은 타마고치 수를 다시 계산하고 업데이트
	        updateActiveTamaCount();
	    }
	
	    // 타마고치 수 업데이트 함수
	    function updateActiveTamaCount() {
	        var activeTamaCount = 0;
	        var rows = document.querySelectorAll('#tamagotchiTable tbody tr');
	
	        // '조회된 다마고치가 없습니다.'를 제외한 나머지 tr만 카운트
	        rows.forEach(function(row) {
	            // 'noDataRow' id를 가진 행은 제외
	            if (row.id !== 'noDataRow') {
	                var isDeleted = row.getAttribute('data-deleted') === 'true'; // 데이터 속성으로 삭제 여부 확인
	                if (!isDeleted) { // 삭제되지 않은 것만 카운트
	                    activeTamaCount++;
	                }
	            }
	        });
	
	        document.getElementById('activeTamaCount').textContent = activeTamaCount; // 갯수 업데이트
	    }
	    
	</script>

</body>
</html>